<script>
  const statusDiv = document.getElementById('status');

  (async () => {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const passcode = urlParams.get('passcode');
      const email = urlParams.get('email');

      if (!passcode || !email) {
        statusDiv.textContent = 'Error: Missing parameters';
        setTimeout(() => window.close(), 2000);
        throw new Error('Missing passcode or email parameters');
      }

      statusDiv.textContent = 'Loading configuration...';

      chrome.storage.sync.get(['emailjsConfig'], async (data) => {
        if (!data.emailjsConfig) {
          statusDiv.textContent = 'Error: EmailJS not configured';
          setTimeout(() => window.close(), 2000);
          return;
        }

        const { serviceId, templateId, publicKey } = data.emailjsConfig;

        if (!serviceId || !templateId || !publicKey) {
          statusDiv.textContent = 'Error: Incomplete EmailJS configuration';
          setTimeout(() => window.close(), 2000);
          return;
        }

        statusDiv.textContent = 'Sending email...';

        const templateParams = {
          to_email: email,
          subject: 'Focus Blocker - Unblock Passcode',
          passcode: passcode,
          message: `Hello!\n\nYour Focus Blocker passcode is: ${passcode}\n\nThis passcode will expire in 10 minutes.\n\nUse this code to modify your blocked sites list. Remember - you requested this to help stay focused!\n\nStay productive!\nFocus Blocker Extension`
        };

        try {
          const response = await fetch("https://api.emailjs.com/api/v1.0/email/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              service_id: serviceId,
              template_id: templateId,
              user_id: publicKey,
              template_params: templateParams
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          console.log('Passcode email sent successfully');
          statusDiv.textContent = 'Email sent successfully! ✅';
          statusDiv.style.color = 'green';
          setTimeout(() => window.close(), 1500);

        } catch (err) {
          console.error('Failed to send passcode email:', err);
          statusDiv.textContent = 'Failed to send email ❌';
          statusDiv.style.color = 'red';
          setTimeout(() => window.close(), 3000);
        }
      });

    } catch (error) {
      console.error('Error in send-email.html:', error);
      statusDiv.textContent = 'An error occurred';
      setTimeout(() => window.close(), 2000);
    }
  })();
</script>
